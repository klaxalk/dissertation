\usetikzlibrary{shapes.geometric,backgrounds,calc}
\pgfdeclarelayer{background}
\pgfdeclarelayer{foreground}
\pgfsetlayers{background,main,foreground}

\begin{tikzpicture}[->,>=stealth', node distance=3.0cm]

  \pgfmathsetmacro{\offsetB}{0.5}

  \node[state, shift = {(0, 0)}] (mpc_controller) {
      \begin{tabular}{c}
        \small Linear MPC \\
        \small controller
      \end{tabular}
    };

  \node[state, right of = mpc_controller, shift = {(0.2, 0.0)}] (uav_model) {
      \begin{tabular}{c}
        \small Linear model \\
        \small $\textbf{x} \leftarrow \textbf{A}\textbf{x} + \textbf{Bu}$
      \end{tabular}
    };

  % \node[state, below of = mpc_controller, shift = {(\offsetB, -1.0)}] (so3_controller) {
  %     \begin{tabular}{c}
  %       \small SO(3) \\
  %       \small controller
  %     \end{tabular}
  %   };

  % \node[state, below of = uav_model, shift = {(0.0, -1.0)}] (attitude_controller) {
  %     \begin{tabular}{c}
  %       \small Attitude\\
  %       \small controller
  %     \end{tabular}
  %   };

    \pgfmathsetmacro{\offsetA}{-1.75}
    \coordinate (under_model) at ($(uav_model.south) + (0.0, \offsetA)$);
    \coordinate (under_mpc) at ($(mpc_controller.south) + (\offsetB, \offsetA)$);
    \path[-] ($(uav_model.south) + (0.0, 0)$) edge [] (under_model) -- (under_model) edge [] (under_mpc) edge [] node[above, midway, shift = {(0.0, 0.10)}] {  
      \begin{tabular}{c}
        \small simulated \\
        \small control loop \\
        \small \textit{100 Hz}
      \end{tabular}} node[below, midway] {$\textbf{x}$} (under_mpc) -- (under_mpc) edge [->] ($(mpc_controller.south) + (\offsetB, 0.0)$);

  \path[-] ($(mpc_controller.east)$) edge [->] node[above, midway] {$\textbf{u}$} ($(uav_model.west)$);

  \path[-] ($(mpc_controller.west) + (-1.3, 0)$) edge [->] node[below, near start, shift = {(0.0, 0.0)}] {  
      \begin{tabular}{c}
        \small reference \\
        \small trajectory
    \end{tabular}} node[above, near start] {$\mathbf{r}_{\mathrm{D}}$, $\mathbf{\phi}_{\mathrm{D}}$} ($(mpc_controller.west)$);

  % \path[-] ($(mpc_controller.south) + (\offsetB, 0)$) edge [->] ($(so3_controller.north) + (0, 0)$);

  % \path[-] ($(so3_controller.east)$) edge [->] node[above, midway] {  
  %     \begin{tabular}{c}
  %       \small $\textbf{R}_D$ \\
  %     \end{tabular}} node[below, midway] {  
  %     \begin{tabular}{c}
  %       \small $T_D$
  %   \end{tabular}} ($(attitude_controller.west)$);

    \pgfmathsetmacro{\backgroundpadding}{0.25}
    \begin{pgfonlayer}{background}
      \path (mpc_controller.west |- mpc_controller.north)+(-\backgroundpadding, \backgroundpadding) node (a) {};
      \path (uav_model.south -| uav_model.east)+(\backgroundpadding,-2.2) node (b) {};
      \path[fill=gray!0, draw=black!50, dashed]
      (a) rectangle (b);

      \path (a) -- node [above, midway, shift = {(0.0, 0.0)}] {\begin{tabular}{c}
          \small MPC trajectory tracker
      \end{tabular}} (uav_model.north -| uav_model.east)+(\backgroundpadding,\backgroundpadding);
    \end{pgfonlayer}

    \path[-] ($(mpc_controller.south) + (-\offsetB, 0)$) edge [-] ($(mpc_controller.south |- under_mpc) + (-\offsetB, 0)$) -- ($(mpc_controller.south |- under_mpc) + (-\offsetB, 0)$) edge [->] node[near end, above, shift = {(-0.25, 0.0)}] {  
      \begin{tabular}{c}
        \small predicted \\
        \small trajectory
    \end{tabular}} ($(mpc_controller.west |- under_mpc) + (-1.3, 0)$);

    \path[-] ($(uav_model.east)$) edge [->] node[near end, above] {$\textbf{x}_D$} ($(uav_model.east) + (0.75, 0)$);

  \end{tikzpicture}
